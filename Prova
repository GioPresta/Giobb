import os
import pandas as pd

# Nomi file input
file1 = "COMMGFNZ.TXT"
file2 = "REPCOMMG.TXT"
output_file = "output_unificato.xlsx"

# Funzione per convertire la data da AAAAMMGG a GG/MM/AAAA
def converti_data(data_str):
    if len(data_str.strip()) != 8:
        return ""
    return f"{data_str[6:8]}/{data_str[4:6]}/{data_str[0:4]}"

# Leggi e unisci i file
def leggi_file(file_path):
    with open(file_path, 'r', encoding='utf-8') as f:
        return f.readlines()

righe = leggi_file(file1) + leggi_file(file2)

dati = []
for riga in righe:
    if len(riga) < 90:
        continue
    tipo_op = riga[62:64]
    if tipo_op == "SD":
        continue
    polizza = riga[0:11].strip()
    garanzia = riga[0:16].strip()
    fondo = riga[16:35].strip()
    commissioni = round(float(riga[35:62].strip() or 0) / 10_000_000, 8)
    data_effetto = converti_data(riga[64:72])
    data_competenza = converti_data(riga[72:81])
    
    dati.append([
        polizza, garanzia, fondo, commissioni, tipo_op,
        data_effetto, data_competenza
    ])

# Crea DataFrame con intestazioni
df = pd.DataFrame(dati, columns=[
    "Polizza", "Garanzia", "Fondo", "Commissioni",
    "Tipo operazione", "Data effetto", "Data competenza"
])

# Scrive il file xlsx nella stessa cartella
df.to_excel(output_file, index=False)

print(f"File generato: {output_file}")

