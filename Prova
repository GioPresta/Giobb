Sub RiepilogoDatiMensili()
    Dim wbMain As Workbook
    Dim wsRiepilogo As Worksheet
    Dim wsMese As Worksheet
    Dim mesi() As String
    Dim ultimaRigaRiepilogo As Long
    Dim ultimaRigaMese As Long
    Dim i As Integer
    Dim rigaMese As Long
    Dim rigaRiepilogo As Long
    Dim nomeMese As String
    
    ' Array con i nomi dei mesi in italiano
    mesi = Split("Gennaio,Febbraio,Marzo,Aprile,Maggio,Giugno,Luglio,Agosto,Settembre,Ottobre,Novembre,Dicembre", ",")
    
    ' Riferimento al workbook corrente
    Set wbMain = ThisWorkbook
    
    ' Usa il foglio attivo (quello dove si trova il pulsante)
    Set wsRiepilogo = ActiveSheet
    
    ' Pulisce il foglio riepilogo (mantiene solo l'intestazione)
    ultimaRigaRiepilogo = wsRiepilogo.Cells(wsRiepilogo.Rows.Count, "A").End(xlUp).Row
    If ultimaRigaRiepilogo > 1 Then
        wsRiepilogo.Rows("2:" & ultimaRigaRiepilogo).Delete
    End If
    
    ' Contatore per la riga di destinazione nel riepilogo
    rigaRiepilogo = 2
    
    ' Cicla attraverso tutti i mesi
    For i = LBound(mesi) To UBound(mesi)
        nomeMese = mesi(i)
        
        ' Verifica se il foglio del mese esiste
        On Error Resume Next
        Set wsMese = wbMain.Worksheets(nomeMese)
        On Error GoTo 0
        
        If Not wsMese Is Nothing Then
            ' Trova l'ultima riga con dati nel foglio mensile (colonna F)
            ultimaRigaMese = wsMese.Cells(wsMese.Rows.Count, "F").End(xlUp).Row
            
            ' Copia i dati se ci sono righe oltre l'intestazione
            If ultimaRigaMese > 1 Then
                For rigaMese = 2 To ultimaRigaMese
                    ' Verifica che la riga non sia vuota
                    If wsMese.Cells(rigaMese, "F").Value <> "" Then
                        ' Fornitore (F -> A)
                        wsRiepilogo.Cells(rigaRiepilogo, "A").Value = wsMese.Cells(rigaMese, "F").Value
                        ' Anagrafica (G -> B)
                        wsRiepilogo.Cells(rigaRiepilogo, "B").Value = wsMese.Cells(rigaMese, "G").Value
                        ' Estremi di fattura (H -> C)
                        wsRiepilogo.Cells(rigaRiepilogo, "C").Value = wsMese.Cells(rigaMese, "H").Value
                        ' Imponibile (I -> D)
                        wsRiepilogo.Cells(rigaRiepilogo, "D").Value = wsMese.Cells(rigaMese, "I").Value
                        ' Spese (J -> E)
                        wsRiepilogo.Cells(rigaRiepilogo, "E").Value = wsMese.Cells(rigaMese, "J").Value
                        ' Quota esente (K -> F)
                        wsRiepilogo.Cells(rigaRiepilogo, "F").Value = wsMese.Cells(rigaMese, "K").Value
                        ' Ritenuta (L -> G)
                        wsRiepilogo.Cells(rigaRiepilogo, "G").Value = wsMese.Cells(rigaMese, "L").Value
                        ' Mese (H)
                        wsRiepilogo.Cells(rigaRiepilogo, "H").Value = nomeMese
                        
                        rigaRiepilogo = rigaRiepilogo + 1
                    End If
                Next rigaMese
            End If
            
            Set wsMese = Nothing
        End If
    Next i
    
    ' Formatta il foglio riepilogo
    With wsRiepilogo
        .Columns("A:H").AutoFit
    End With
    
    MsgBox "Riepilogo completato! Totale righe copiate: " & (rigaRiepilogo - 2), vbInformation
    
End Sub