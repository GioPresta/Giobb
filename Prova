import pandas as pd
import re

# Funzione per processare ogni riga
def process_line(line):
    try:
        parts = line.strip().split()
        if len(parts) != 3:
            return None

        # Estrai e separa Polizza e Garanzia
        match = re.match(r"(\d+)([A-Z0-9]{5})", parts[0])
        if not match:
            return None
        polizza, garanzia = match.groups()

        fondo = parts[1]
        raw_third = parts[2].lstrip('0')

        # Ignora righe con tipo operazione 'SD'
        match = re.match(r"(\d+)([A-Z]{2})(\d{8})(\d{8})", raw_third)
        if not match:
            return None
        commissioni_raw, tipo_op, data_effetto_raw, data_competenza_raw = match.groups()

        if tipo_op == 'SD':
            return None

        # Riformatta i valori
        commissioni = int(commissioni_raw) / 10_000_000
        data_effetto = f"{data_effetto_raw[6:8]}/{data_effetto_raw[4:6]}/{data_effetto_raw[0:4]}"
        data_competenza = f"{data_competenza_raw[6:8]}/{data_competenza_raw[4:6]}/{data_competenza_raw[0:4]}"

        return {
            "Polizza": polizza,
            "Garanzia": garanzia,
            "Fondo": fondo,
            "Commissioni": commissioni,
            "Tipo operazione": tipo_op,
            "Data effetto": data_effetto,
            "Data competenza": data_competenza
        }

    except Exception:
        return None

# Leggi e unisci i due file
file1 = "COMMGFNZ.TXT"
file2 = "REPCOMMG.TXT"
all_lines = []

for file in [file1, file2]:
    with open(file, "r", encoding="utf-8") as f:
        lines = f.readlines()
        for line in lines:
            processed = process_line(line)
            if processed:
                all_lines.append(processed)

# Crea DataFrame e salva in xlsx
df = pd.DataFrame(all_lines)
df.to_excel("output_commissioni.xlsx", index=False)