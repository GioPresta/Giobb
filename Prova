import pandas as pd
from datetime import datetime

# File di input e output
input_file = "REPCOMMG.TXT"
output_file = "output_repcommg.xlsx"

# Funzione per convertire la data da AAAAMMGG a datetime
def converti_data(data_str):
    if len(data_str.strip()) == 8:
        try:
            anno = int(data_str[0:4])
            mese = int(data_str[4:6])
            giorno = int(data_str[6:8])
            return datetime(anno, mese, giorno)
        except ValueError:
            return None
    return None

# Leggi il file
with open(input_file, 'r', encoding='utf-8') as f:
    righe = f.readlines()

print(f"File letto. Righe totali: {len(righe)}")

# Lista per i dati
dati = []

# Processa ogni riga
for riga in righe:
    if len(riga) < 137 or "SD" in riga:
        continue
    
    try:
        # Posizioni aggiornate
        polizza = riga[0:11].strip()
        garanzia_raw = riga[11:16].strip()
        garanzia = garanzia_raw[1:] if garanzia_raw.startswith('T') else garanzia_raw
        fondo = riga[16:35].strip()
        commissioni_str = riga[35:62].strip()
        
        if commissioni_str and commissioni_str.isdigit():
            commissioni = round(float(commissioni_str) / 10_000_000, 8)
        else:
            commissioni = 0
        
        data_effetto = converti_data(riga[121:129].strip())
        data_competenza = converti_data(riga[129:137].strip())
        
        if polizza:
            dati.append({
                'Polizza': polizza,
                'Garanzia': garanzia,
                'Fondo': fondo,
                'Commissioni': commissioni,
                'Data effetto': data_effetto,
                'Data competenza': data_competenza
            })
    except:
        continue

# Crea tabella Excel con date formattate
df = pd.DataFrame(dati)

# Salva con formattazione date
with pd.ExcelWriter(output_file, engine='openpyxl', date_format='DD/MM/YYYY') as writer:
    df.to_excel(writer, index=False)

print(f"File Excel creato: {output_file}")
print(f"Righe processate: {len(df)}")

# Debug: mostra una riga di esempio per verificare le posizioni
if len(righe) > 0:
    riga_esempio = righe[0]
    print(f"\nRiga di esempio (primi 150 caratteri):")
    print(f"'{riga_esempio[:150]}'")
    print(f"Lunghezza riga: {len(riga_esempio)}")
    
    if len(riga_esempio) >= 137:
        print(f"\nDati estratti dalla prima riga:")
        print(f"Data effetto (pos 121:129): '{riga_esempio[121:129]}'")
        print(f"Data competenza (pos 129:137): '{riga_esempio[129:137]}'")
    else:
        print("Riga troppo corta per contenere le date nelle posizioni specificate!")