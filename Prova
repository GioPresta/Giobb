import os import sys import glob import datetime import traceback import customtkinter as ctk from tkinter import filedialog, messagebox

Directories

BASE_DIR = os.path.dirname(os.path.abspath(file)) PROJECT_ROOT = os.path.dirname(os.path.dirname(BASE_DIR)) INPUTS_DIR = os.path.join(PROJECT_ROOT, "Inputs") RESULTS_DIR = os.path.join(PROJECT_ROOT, "results", "AssetPricing_results") SOURCES_DIR = os.path.join(PROJECT_ROOT, "Sources") os.makedirs(INPUTS_DIR, exist_ok=True) os.makedirs(RESULTS_DIR, exist_ok=True)

if SOURCES_DIR not in sys.path: sys.path.append(SOURCES_DIR)

Helpers

def shorten_path(full_path): if not full_path: return "" try: mtime = os.path.getmtime(full_path) except: return os.path.basename(full_path) ts = datetime.datetime.fromtimestamp(mtime).strftime("%d/%m/%Y %H:%M") return f"{os.path.basename(full_path)} ({ts})"

def find_first(pattern): files = sorted(glob.glob(os.path.join(INPUTS_DIR, pattern))) return files[0] if files else ""

ctk.set_appearance_mode("dark") ctk.set_default_color_theme("blue")

class GUI(ctk.CTk): def init(self): super().init()

self.title("Asset Pricing CARDIF - GUI 3.13.7")
    self.geometry("900x600")
    self.resizable(False, False)

    icon_path = os.path.join(INPUTS_DIR, "favicon.ico")
    if os.path.exists(icon_path):
        try:
            self.iconbitmap(default=icon_path)
        except:
            pass

    # Variables
    self.assets_dataset       = ctk.StringVar()
    self.assets_dataset_disp  = ctk.StringVar()
    self.spot_curve           = ctk.StringVar()
    self.spot_curve_disp      = ctk.StringVar()
    self.spread_input         = ctk.StringVar()
    self.spread_input_disp    = ctk.StringVar()
    self.inflation_index      = ctk.StringVar()
    self.inflation_index_disp = ctk.StringVar()
    self.output_dir           = ctk.StringVar(value=RESULTS_DIR)
    self.output_dir_disp      = ctk.StringVar(value=shorten_path(RESULTS_DIR))

    self.valuation_date = ctk.StringVar(value="2025-09-30")
    self.spread_up      = ctk.StringVar(value="0.5")
    self.spread_down    = ctk.StringVar(value="0.5")
    self.ufr            = ctk.StringVar(value="3.3")

    self.container = ctk.CTkFrame(self, corner_radius=12)
    self.container.pack(fill="both", expand=True, padx=10, pady=10)

    self.build_ui()
    self.autofill()

def build_ui(self):
    title = ctk.CTkLabel(self.container, text="Asset Pricing CARDIF — Repricing 3.13.7",
                         font=ctk.CTkFont(size=24, weight="bold"))
    title.pack(pady=(0,10))

    form = ctk.CTkFrame(self.container, corner_radius=12, fg_color="#1b1f24")
    form.pack(fill="both", expand=True)
    form.grid_columnconfigure(1, weight=1)

    rows = [
        ("Asset dataset", self.assets_dataset, self.assets_dataset_disp),
        ("Spot curve", self.spot_curve, self.spot_curve_disp),
        ("Spread input", self.spread_input, self.spread_input_disp),
        ("Inflation index", self.inflation_index, self.inflation_index_disp)
    ]

    r = 0
    for label, var, disp in rows:
        ctk.CTkLabel(form, text=label).grid(row=r, column=0, sticky="w", padx=10, pady=5)
        ctk.CTkEntry(form, textvariable=disp, state="readonly", fg_color="#3a3f44").grid(row=r, column=1, sticky="ew", padx=10, pady=5)
        ctk.CTkButton(form, text="Browse", width=80,
                       command=lambda v=var, d=disp: self.pick_file(v, d)).grid(row=r, column=2, padx=10, pady=5)
        r += 1

    # Editable fields
    fields = [
        ("Valuation date (YYYY-MM-DD)", self.valuation_date),
        ("Spread up", self.spread_up),
        ("Spread down", self.spread_down),
        ("UFR %", self.ufr)
    ]

    for label, var in fields:
        ctk.CTkLabel(form, text=label).grid(row=r, column=0, sticky="w", padx=10, pady=5)
        ctk.CTkEntry(form, textvariable=var).grid(row=r, column=1, sticky="ew", padx=10, pady=5)
        r += 1

    # Output dir
    ctk.CTkLabel(form, text="Output directory").grid(row=r, column=0, sticky="w", padx=10, pady=5)
    ctk.CTkEntry(form, textvariable=self.output_dir_disp, state="readonly",
                 fg_color="#3a3f44").grid(row=r, column=1, sticky="ew", padx=10, pady=5)
    ctk.CTkButton(form, text="Browse", width=80, command=self.pick_output).grid(row=r, column=2, padx=10, pady=5)
    r += 1

    # Run
    self.run_btn = ctk.CTkButton(self.container, text="Run Asset Pricing Script",
                                 fg_color="#00A678", command=self.execute)
    self.run_btn.pack(fill="x", pady=(10,5))

    self.log = ctk.CTkLabel(self.container, text="", anchor="w")
    self.log.pack(fill="x")

def autofill(self):
    self.assets_dataset.set(find_first("Asset_tool_*.xlsx"))
    self.assets_dataset_disp.set(shorten_path(self.assets_dataset.get()))

    self.spot_curve.set(find_first("Spot_curve_central_*.xlsx"))
    self.spot_curve_disp.set(shorten_path(self.spot_curve.get()))

    self.spread_input.set(find_first("Spreads_tasso_variabile_*.xlsx"))
    self.spread_input_disp.set(shorten_path(self.spread_input.get()))

    self.inflation_index.set(find_first("inflation_index_*.xlsx"))
    self.inflation_index_disp.set(shorten_path(self.inflation_index.get()))

def pick_file(self, var, disp):
    p = filedialog.askopenfilename(initialdir=INPUTS_DIR,
                                   filetypes=[("Excel", "*.xlsx;*.xls")])
    if p:
        var.set(p)
        disp.set(shorten_path(p))

def pick_output(self):
    p = filedialog.askdirectory(initialdir=RESULTS_DIR)
    if p:
        self.output_dir.set(p)
        self.output_dir_disp.set(shorten_path(p))

def execute(self):
    self.run_btn.configure(state="disabled")
    self.log.configure(text="Running…")
    self.after(200, self._run)

def _run(self):
    try:
        from AssetPricingSource.Options import Options
        from AssetPricingSource.Executor import Executor
        from AssetPricingSource.Initializer import Initializer
        from AssetPricingSource.Reader import Reader
        from AssetPricingSource.PostProcessing import PostProcessing
        from AssetPricingSource.Writer import Writer
        from AssetPricingSource.SmithWilsonModel import SmithWilsonModel

        options = Options(
            assets_dataset_path=self.assets_dataset.get(),
            yearly_spot_rates_curve_path=self.spot_curve.get(),
            spread_input_path=self.spread_input.get(),
            inflation_index_path=self.inflation_index.get(),
            yearly_shocked_spot_rates_curve_path="",
            valuation_date=self.valuation_date.get(),
            curves_by_rating="",
            sensitivity_risk="Interest",
            spread_up=float(self.spread_up.get()),
            spread_down=float(self.spread_down.get()),
            UFR=float(self.ufr.get())/100,
            output_directory=self.output_dir.get()
        )

        initializer = Initializer(options)
        sw = SmithWilsonModel(options)
        reader = Reader(options, sw)
        pp = PostProcessing(options)
        writer = Writer(options)
        Executor(options, initializer, reader, pp, writer).run()

        self.log.configure(text="Completed successfully.")
    except Exception as e:
        traceback.print_exc()
        self.log.configure(text=f"Error: {e}")
    finally:
        self.run_btn.configure(state="normal")

if name == "main": gui = GUI() gui.mainloop()